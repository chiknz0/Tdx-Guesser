<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2761094953116204" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0PBBF2HHSL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0PBBF2HHSL');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDX Guessr - Tower Guessing Game</title>
    <meta name="description" content="The best TDX guessing game. Test your knowledge of towers, rarities, and descriptions in this ultimate fan-made challenge.">
    <link rel="icon" type="image/png" href="assets/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7)), 
                        url('https://i.postimg.cc/HLxVCWzc/maxresdefault.jpg'),
                        url('assets/background.jpg.jpg'),
                        #121212;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            margin: 0;
            padding: 1rem;
            font-size: 0.75rem;
        }

        .game-wrapper {
            width: 100%;
            max-width: 340px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }

        .glass-box {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 0.6rem;
        }

        .mode-btn {
            transition: all 0.2s ease;
            filter: grayscale(100%);
            opacity: 0.5;
            cursor: pointer;
        }

        .mode-btn.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.05);
            border-bottom: 2px solid #fbbf24;
        }

        .pixel-container {
            width: 120px;
            height: 120px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border-radius: 8px;
            border: 1px solid #333;
            position: relative;
        }

        #pixelCanvas {
            width: 120px;
            height: 120px;
            image-rendering: pixelated;
        }

        .correct { background-color: #16a34a !important; border: 1px solid #22c55e; }
        .incorrect { background-color: #991b1b !important; border: 1px solid #ef4444; }
        .neutral { background-color: #3f3f46 !important; border: 1px solid #71717a; }
        
        .suggestion-item:hover { background-color: #1d4ed8; }
        
        .btn-discord { background-color: #5865F2; color: white; transition: background-color 0.2s; }
        .btn-discord:hover { background-color: #4752c4; }
        .btn-donate { background-color: #FFDD00; color: #000000; transition: background-color 0.2s; }
        .btn-donate:hover { background-color: #e6c700; }
        
        .auth-input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 8px;
            font-size: 0.7rem;
        }

        .pfp-preview {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fbbf24;
            margin: 0 auto 10px;
        }

        .action-icon-btn {
            background: rgba(0,0,0,0.6);
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .animate-reveal {
            animation: reveal 0.2s ease-out forwards;
        }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body onclick="startAudio()">

    <!-- Audio & Version Controls -->
    <div class="fixed top-2 left-2 z-50 flex flex-col gap-1.5">
        <div class="flex gap-1.5">
            <button onclick="toggleMusic()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition">
                <span id="musicIcon" class="text-lg">üîá</span>
            </button>
            <button onclick="toggleUpdateLog()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition">
                <span class="text-lg">üìú</span>
            </button>
        </div>
        <div class="glass-box !py-1 !px-2 opacity-50 w-fit">
            <span class="text-[8px] font-black uppercase tracking-tighter">Version 3.0</span>
        </div>
    </div>

    <!-- Stats and Profile -->
    <div class="fixed top-2 right-2 flex flex-col gap-1.5 z-50">
        <button onclick="openAuth()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition" title="Profile">
            <span class="text-xl">üë§</span>
        </button>
        <button onclick="toggleLeaderboard()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition" title="Leaderboard">
            <span class="text-xl">üèÜ</span>
        </button>
        <button onclick="toggleLeaderboard()" class="glass-box !p-0 flex flex-col items-center justify-center !w-10 !h-10 hover:bg-gray-800 transition" title="Your Streak">
            <span class="text-lg">üî•</span>
            <span id="streakCount" class="text-[8px] font-black -mt-1">0</span>
        </button>
    </div>

    <!-- Update Log Modal -->
    <div id="updateModal" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[280px]">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">Update Log (v3)</h2>
            <ul class="text-[9px] text-gray-300 space-y-2 uppercase list-disc list-inside">
                <li>Discord Login Support</li>
                <li>Fixed Profile Picture Sync</li>
                <li>Menu now auto-closes after login</li>
                <li>Added Versioning and Logs</li>
                <li>Username length protection</li>
            </ul>
            <button onclick="toggleUpdateLog()" class="mt-4 w-full bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Dismiss</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[280px] text-center">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-4">Account Access</h2>
            
            <div id="authForm">
                <input type="text" id="authUsername" placeholder="Username" class="auth-input">
                <input type="password" id="authPass" placeholder="Password" class="auth-input">
                
                <div id="signupFields" class="hidden">
                    <input type="text" id="authPfp" placeholder="PFP Image URL (optional)" class="auth-input">
                    <p class="text-[7px] text-gray-500 mb-2 uppercase">NSFW profile pictures will lead to a ban.</p>
                </div>
                
                <div class="flex flex-col gap-2 mt-2">
                    <button id="mainAuthBtn" onclick="handleAuth()" class="bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Sign In</button>
                    <button onclick="loginWithDiscord()" class="bg-[#5865F2] text-white font-black py-2 rounded-lg text-xs uppercase flex items-center justify-center gap-2">
                        <img src="https://img.icons8.com/ios-filled/50/ffffff/discord-logo.png" class="w-3 h-3"> Continue with Discord
                    </button>
                    <button id="toggleAuthMode" onclick="toggleAuthUI()" class="text-gray-400 font-bold py-1 text-[9px] uppercase hover:text-white">Need an account? Sign Up</button>
                </div>
            </div>

            <!-- Username selection for OAuth users -->
            <div id="setUsernameSection" class="hidden py-2">
                <p class="text-[9px] text-gray-400 mb-2 uppercase">Choose a username to finish setup</p>
                <input type="text" id="newOauthUsername" placeholder="Username" class="auth-input">
                <button onclick="finalizeOauthName()" class="w-full bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Save Username</button>
            </div>
            
            <div id="userInfoSection" class="hidden py-2">
                <img id="profilePfp" src="" class="pfp-preview">
                <p id="profileUserDisplay" class="text-sm font-black text-yellow-500 mb-1"></p>
                <p id="profileStreakDisplay" class="text-[10px] text-gray-400 mb-4 uppercase"></p>
                
                <div class="mb-4">
                    <input type="text" id="updatePfpUrl" placeholder="New PFP Image URL" class="auth-input !mb-1 !text-[9px]">
                    <button onclick="updatePfp()" class="text-[8px] text-yellow-500 font-bold uppercase hover:underline">Change PFP</button>
                </div>

                <button onclick="handleSignOut()" class="bg-red-900/40 text-red-400 border border-red-900 font-bold py-2 px-4 rounded-lg text-[10px] uppercase">Sign Out</button>
            </div>

            <button onclick="closeAuth()" class="mt-4 text-[8px] text-gray-500 uppercase">Close</button>
            <p id="authStatus" class="text-[8px] mt-2 text-gray-400 min-h-[1.5em]"></p>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[300px]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-yellow-500 font-black uppercase text-sm">Top Defenders</h2>
                <button onclick="toggleLeaderboard()" class="text-gray-500">‚úï</button>
            </div>
            <div id="leaderboardList" class="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                <p class="text-center text-[10px] text-gray-400">Loading rankings...</p>
            </div>
            <div class="mt-4 pt-4 border-t border-white/10 text-center">
                <button onclick="openAuth()" class="text-[10px] text-yellow-500 font-bold uppercase">View My Profile</button>
            </div>
        </div>
    </div>

    <div class="game-wrapper">
        <div class="flex flex-col items-center mb-1">
            <img src="assets/logo.png" alt="TDX Guessr Logo" onerror="this.src='https://i.postimg.cc/Sj6mc3GZ/unnamed.png'" class="w-full max-h-24 object-contain">
        </div>

        <div class="glass-box">
            <div class="grid grid-cols-4 gap-1.5">
                <button onclick="changeMode('classic')" id="mode-classic" class="mode-btn active flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/sword.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Classic</span>
                </button>
                <button onclick="changeMode('pixel')" id="mode-pixel" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/picture.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Pixel</span>
                </button>
                <button onclick="changeMode('emoji')" id="mode-emoji" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/happy.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Emoji</span>
                </button>
                <button onclick="changeMode('description')" id="mode-description" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/document.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Desc</span>
                </button>
            </div>

            <div class="mt-2 px-1">
                <div class="flex justify-between text-[8px] mb-1 text-gray-400 font-bold">
                    <span>DAILY PROGRESS</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-900 h-1 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-yellow-500 h-full w-0 transition-all duration-500"></div>
                </div>
            </div>
        </div>

        <div class="glass-box flex flex-col items-center">
            <div id="displayArea" class="w-full min-h-[140px] flex flex-col items-center justify-center">
                <div id="pixelDisplay" class="hidden text-center relative w-full">
                    <div class="pixel-container mx-auto shadow-inner relative group">
                        <canvas id="pixelCanvas" width="120" height="120"></canvas>
                        <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="text-[10px]">üîÑ</span>
                        </button>
                    </div>
                </div>

                <div id="emojiDisplay" class="hidden text-center w-full">
                    <div class="flex items-center justify-center gap-2">
                        <div id="emojiSlots" class="flex gap-1.5 text-2xl bg-black/50 p-3 rounded-lg min-h-[50px] min-w-[120px] justify-center items-center"></div>
                        <button onclick="refreshTower()" class="action-icon-btn">
                            <span class="text-[12px]">üîÑ</span>
                        </button>
                    </div>
                </div>

                <div id="descriptionDisplay" class="hidden text-center p-3 bg-black/40 rounded-lg w-full relative group">
                    <p id="descText" class="text-[10px] italic text-yellow-50"></p>
                    <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px]">üîÑ</span>
                    </button>
                </div>

                <div id="classicDisplay" class="text-center p-2 relative group w-full">
                    <h3 class="text-lg mb-1 text-yellow-400 uppercase font-black">Unknown Tower</h3>
                    <p class="text-gray-400 text-[9px] uppercase">Submit guesses to see stats</p>
                    <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px]">üîÑ</span>
                    </button>
                </div>
            </div>

            <div id="interactionSection" class="w-full relative mt-2">
                <input type="text" id="guessInput" placeholder="Guess a tower..." autocomplete="off"
                       class="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-sm focus:border-yellow-500 outline-none text-white">
                <div id="suggestions" class="absolute bottom-full left-0 w-full glass-box mb-2 max-h-40 overflow-y-auto hidden z-50 !p-1"></div>
                
                <button onclick="giveUp()" id="giveUpBtn" class="w-full mt-2 text-[8px] font-bold text-gray-500 uppercase hover:text-red-400 transition-colors py-1">
                    Give Up? (Reveal Answer)
                </button>
            </div>

            <div id="winControls" class="hidden w-full mt-2 flex flex-col gap-1.5">
                <div id="winStatusText" class="text-center text-[10px] font-black uppercase mb-1"></div>
                <button onclick="resetGame()" class="w-full bg-green-600 hover:bg-green-500 p-2 rounded-lg font-black text-xs">NEXT ROUND</button>
            </div>

            <div id="guessHistory" class="w-full mt-3 space-y-1"></div>
        </div>

        <div class="flex gap-1.5 w-full">
            <a href="https://discord.gg/r7JXFmk8Ku" target="_blank" class="btn-discord flex-1 flex items-center justify-center gap-2 py-2 rounded-lg shadow-lg">
                <span class="text-[9px] font-black uppercase">Discord</span>
            </a>
            <a href="https://buymeacoffee.com/tdxguesser" target="_blank" class="btn-donate flex-1 flex items-center justify-center gap-2 py-2 rounded-lg shadow-lg">
                <span class="text-[9px] font-black uppercase">Donate</span>
            </a>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://swfgmqyadbtvgolrgbix.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZmdtcXlhZGJ0dmdvbHJnYml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NTE3MTksImV4cCI6MjA4MjQyNzcxOX0.8ynHDvE5APE_UC-RCItdSus86pjaijGlbvuVYh0QKpU';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const towers = [
            { name: "Ranger", img: "https://static.wikia.nocookie.net/tdx/images/6/61/RangerNew.png", desc: "Starter Tower, Shoots Basic Rifle", emojis: ["üî´", "üå≤", "üéØ", "üö∂"] },
            { name: "Shotgunner", img: "https://static.wikia.nocookie.net/tdx/images/5/56/ShotgunnerBase.png", desc: "Uses a shotgun", emojis: ["üêö", "üî•", "üí®", "üõ°Ô∏è"] },
            { name: "Operator", img: "https://static.wikia.nocookie.net/tdx/images/6/66/Operator_0.png", desc: "Has a fast gun and can spawn cars", emojis: ["üöó", "‚ö°", "üî´", "üìû"] },
            { name: "Mine Layer", img: "https://static.wikia.nocookie.net/tdx/images/a/a2/Mine_Layer_0.png", desc: "Puts mines on track every so often", emojis: ["üí£", "üõ£Ô∏è", "üë∑", "üí•"] },
            { name: "Sniper", img: "https://static.wikia.nocookie.net/tdx/images/f/f7/Sniper_0.png", desc: "Long Ranger Sniper", emojis: ["üî≠", "üèπ", "üèîÔ∏è", "üéØ"] },
            { name: "Farm", img: "https://static.wikia.nocookie.net/tdx/images/b/bb/Farm_0_IG.png", desc: "Generates money every wave", emojis: ["üí∞", "üåΩ", "üöú", "üí∏"] },
            { name: "Juggernaut", img: "https://static.wikia.nocookie.net/tdx/images/f/f2/Jug_0.png", desc: "A minigun troop", emojis: ["ü¶æ", "üî•", "üî´", "üõ°Ô∏è"] }
        ];

        let currentMode = 'classic';
        let targetTower = null;
        let guesses = [];
        let winState = false;
        let streak = 0;
        let currentUser = null;
        let authMode = 'signin';
        let musicOn = false;
        let audioStarted = false;

        const BANNED_WORDS = ["admin", "moderator", "staff"]; 

        function toggleUpdateLog() { document.getElementById('updateModal').classList.toggle('hidden'); }
        function startAudio() { if (!audioStarted) audioStarted = true; }
        function toggleMusic() { musicOn = !musicOn; document.getElementById('musicIcon').innerText = musicOn ? 'üîä' : 'üîá'; }

        function toggleAuthUI() {
            authMode = authMode === 'signin' ? 'signup' : 'signin';
            const signupFields = document.getElementById('signupFields');
            const mainBtn = document.getElementById('mainAuthBtn');
            const toggleBtn = document.getElementById('toggleAuthMode');
            const status = document.getElementById('authStatus');
            status.innerText = "";
            
            if(authMode === 'signup') {
                signupFields.classList.remove('hidden');
                mainBtn.innerText = "Create Account";
                toggleBtn.innerText = "Already have an account? Sign In";
            } else {
                signupFields.classList.add('hidden');
                mainBtn.innerText = "Sign In";
                toggleBtn.innerText = "Need an account? Sign Up";
            }
        }

        async function loginWithDiscord() {
            const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'discord' });
            if (error) document.getElementById('authStatus').innerText = "Discord Error: " + error.message;
        }

        async function finalizeOauthName() {
            const username = document.getElementById('newOauthUsername').value.trim();
            const status = document.getElementById('authStatus');
            if (username.length < 3) { status.innerText = "Username too short."; return; }
            
            const { error } = await supabaseClient.from('players').insert([{ 
                id: currentUser.id, 
                username: username, 
                best_streak: streak,
                pfp: currentUser.user_metadata.avatar_url || "https://img.icons8.com/color/96/user.png"
            }]);

            if (error) status.innerText = "Error: Name might be taken.";
            else { status.innerText = "Profile created!"; checkUser(); }
        }

        async function handleAuth() {
            const usernameInput = document.getElementById('authUsername').value.trim();
            const passInput = document.getElementById('authPass').value;
            const status = document.getElementById('authStatus');
            
            if (!usernameInput || usernameInput.length < 3) { status.innerText = "Username too short."; return; }
            if (BANNED_WORDS.some(word => usernameInput.toLowerCase().includes(word))) { status.innerText = "Invalid username."; return; }
            if (passInput.length < 6) { status.innerText = "Password too short."; return; }

            const shadowEmail = `${usernameInput.toLowerCase()}@tdxguessr.com`;
            status.innerText = "Processing...";
            
            try {
                if(authMode === 'signup') {
                    const pfpUrl = document.getElementById('authPfp').value;
                    const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email: shadowEmail, password: passInput });
                    if(authError) throw authError;

                    if(authData.user) {
                        await supabaseClient.from('players').insert([{ 
                            id: authData.user.id, 
                            username: usernameInput, 
                            best_streak: streak,
                            pfp: (pfpUrl && pfpUrl.trim() !== "") ? pfpUrl : "https://img.icons8.com/color/96/user.png"
                        }]);
                        status.innerText = "Success! Signing in...";
                        setTimeout(() => { closeAuth(); checkUser(); }, 1000);
                    }
                } else {
                    const { error } = await supabaseClient.auth.signInWithPassword({ email: shadowEmail, password: passInput });
                    if(error) throw error;
                    status.innerText = "Welcome back!";
                    setTimeout(() => { closeAuth(); checkUser(); }, 500);
                }
            } catch (e) { status.innerText = "Error: " + e.message; }
        }

        async function updatePfp() {
            if(!currentUser) return;
            const newUrl = document.getElementById('updatePfpUrl').value;
            if(!newUrl) return;
            const { error } = await supabaseClient.from('players').update({ pfp: newUrl }).eq('id', currentUser.id);
            if(!error) await checkUser();
        }

        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user || null;
            
            const authForm = document.getElementById('authForm');
            const userInfo = document.getElementById('userInfoSection');
            const setUsernameForm = document.getElementById('setUsernameSection');
            const display = document.getElementById('profileUserDisplay');
            const pfpImg = document.getElementById('profilePfp');

            if(currentUser) {
                const { data } = await supabaseClient.from('players').select('*').eq('id', currentUser.id).maybeSingle();
                if(data) {
                    authForm.classList.add('hidden');
                    setUsernameForm.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                    display.innerText = data.username;
                    pfpImg.src = data.pfp || "https://img.icons8.com/color/96/user.png";
                    streak = Math.max(streak, data.best_streak || 0);
                    updateStreakUI();
                    // Auto close after verification
                    if (!document.getElementById('authModal').classList.contains('hidden')) {
                         setTimeout(closeAuth, 1000);
                    }
                } else {
                    authForm.classList.add('hidden');
                    setUsernameForm.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                }
            } else {
                authForm.classList.remove('hidden');
                setUsernameForm.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
        }

        async function fetchLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const { data, error } = await supabaseClient.from('players').select('*').order('best_streak', { ascending: false }).limit(10);
            if(error) { list.innerHTML = `<p class='text-red-500'>Error loading stats.</p>`; return; }
            list.innerHTML = data.map((player, i) => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded">
                    <div class="flex items-center gap-2">
                        <span class="text-yellow-500 font-black">#${i+1}</span>
                        <img src="${player.pfp || 'https://img.icons8.com/color/96/user.png'}" class="w-6 h-6 rounded-full border border-white/10">
                        <span class="text-[9px] font-bold">${player.username}</span>
                    </div>
                    <span class="text-green-500 font-black">${player.best_streak} üî•</span>
                </div>
            `).join('');
        }

        function changeMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            ['pixelDisplay', 'emojiDisplay', 'descriptionDisplay', 'classicDisplay'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(mode + 'Display').classList.remove('hidden');
            resetGame();
        }

        function refreshTower() { resetGame(); }

        function resetGame() {
            guesses = [];
            winState = false;
            targetTower = towers[Math.floor(Math.random() * towers.length)];
            document.getElementById('winControls').classList.add('hidden');
            document.getElementById('interactionSection').classList.remove('hidden');
            document.getElementById('guessInput').disabled = false;
            document.getElementById('guessInput').value = '';
            document.getElementById('guessHistory').innerHTML = '';
            updateDisplay();
        }

        function updateDisplay() {
            if(currentMode === 'emoji') {
                document.getElementById('emojiSlots').innerHTML = targetTower.emojis.map((e, i) => i < 1 ? `<span class="animate-reveal">${e}</span>` : `<span class="opacity-10">?</span>`).join('');
            } else if(currentMode === 'description') {
                const words = targetTower.desc.split(' ');
                document.getElementById('descText').innerHTML = words.map((w, i) => i < 1 ? w : '_'.repeat(w.length)).join(' ');
            } else if(currentMode === 'pixel') {
                drawPixelated();
            }
        }

        function drawPixelated() {
            const canvas = document.getElementById('pixelCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = targetTower.img;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, 16, 16);
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(canvas, 0, 0, 16, 16, 0, 0, canvas.width, canvas.height);
            };
        }

        function giveUp() {
            if(winState) return;
            winState = true;
            document.getElementById('winStatusText').innerText = "IT WAS: " + targetTower.name;
            document.getElementById('winControls').classList.remove('hidden');
            document.getElementById('interactionSection').classList.add('hidden');
            streak = 0;
            updateStreakUI();
        }

        function handleGuess(name) {
            if(winState) return;
            const guess = towers.find(t => t.name.toLowerCase() === name.trim().toLowerCase());
            if(!guess) return;
            document.getElementById('suggestions').classList.add('hidden');
            document.getElementById('guessInput').value = '';
            guesses.push(guess);
            if(guess.name === targetTower.name) {
                winState = true;
                streak++;
                document.getElementById('winStatusText').innerText = "CORRECT!";
                document.getElementById('winControls').classList.remove('hidden');
                document.getElementById('interactionSection').classList.add('hidden');
                updateStreakUI();
                if(currentUser) saveStreak();
            }
            addGuessRow(guess);
        }

        async function saveStreak() {
            const { data } = await supabaseClient.from('players').select('best_streak').eq('id', currentUser.id).maybeSingle();
            if(data && streak > data.best_streak) {
                await supabaseClient.from('players').update({ best_streak: streak }).eq('id', currentUser.id);
            }
        }

        function addGuessRow(guess) {
            const container = document.getElementById('guessHistory');
            const row = document.createElement('div');
            const isCorrect = guess.name === targetTower.name;
            row.className = `flex items-center gap-2 glass-box !p-1.5 ${isCorrect ? 'correct' : 'incorrect'} border-2`;
            row.innerHTML = `<img src="${guess.img}" class="w-8 h-8 rounded"> <span class="text-[10px] font-black uppercase">${guess.name}</span>`;
            container.prepend(row);
        }

        function showSuggestions(e) {
            const val = e.target.value.toLowerCase();
            const suggCont = document.getElementById('suggestions');
            if(!val) { suggCont.classList.add('hidden'); return; }
            const matches = towers.filter(t => t.name.toLowerCase().includes(val));
            if(matches.length > 0) {
                suggCont.innerHTML = matches.map(m => `<div class="p-1.5 cursor-pointer flex items-center gap-2" onclick="handleGuess('${m.name}')">
                    <img src="${m.img}" class="w-5 h-5 rounded"><span class="text-[8px] font-bold uppercase">${m.name}</span></div>`).join('');
                suggCont.classList.remove('hidden');
            } else suggCont.classList.add('hidden');
        }

        function openAuth() { document.getElementById('authModal').classList.remove('hidden'); checkUser(); }
        function closeAuth() { document.getElementById('authModal').classList.add('hidden'); }
        function toggleLeaderboard() { 
            const lb = document.getElementById('leaderboardModal');
            lb.classList.toggle('hidden');
            if(!lb.classList.contains('hidden')) fetchLeaderboard();
        }
        function updateStreakUI() { document.getElementById('streakCount').innerText = streak; }
        async function handleSignOut() { await supabaseClient.auth.signOut(); currentUser = null; location.reload(); }

        window.onload = () => {
            checkUser();
            resetGame();
            document.getElementById('guessInput').addEventListener('input', showSuggestions);
            document.getElementById('guessInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleGuess(e.target.value); });
        };
    </script>
</body>
</html>
