<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2761094953116204" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0PBBF2HHSL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0PBBF2HHSL');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TDX Guessr - Tower Guessing Game</title>
    <meta name="description" content="The best TDX guessing game. Test your knowledge of towers, rarities, and descriptions in this ultimate fan-made challenge.">
    <link rel="icon" type="image/png" href="assets/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.7)), 
                        url('https://i.postimg.cc/HLxVCWzc/maxresdefault.jpg'),
                        url('assets/background.jpg.jpg'),
                        #121212;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            margin: 0;
            padding: 1rem;
            font-size: 0.75rem;
        }

        .game-wrapper {
            width: 100%;
            max-width: 340px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }

        .glass-box {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 0.6rem;
        }

        .mode-btn {
            transition: all 0.2s ease;
            filter: grayscale(100%);
            opacity: 0.5;
            cursor: pointer;
        }

        .mode-btn.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.05);
            border-bottom: 2px solid #fbbf24;
        }

        .pixel-container {
            width: 120px;
            height: 120px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border-radius: 8px;
            border: 1px solid #333;
            position: relative;
        }

        #pixelCanvas {
            width: 120px;
            height: 120px;
            image-rendering: pixelated;
        }

        .correct { background-color: #16a34a !important; border: 1px solid #22c55e; }
        .incorrect { background-color: #991b1b !important; border: 1px solid #ef4444; }
        
        .action-icon-btn {
            background: rgba(0,0,0,0.6);
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            font-size: 6px;
            font-weight: 900;
            text-transform: uppercase;
            min-width: 45px;
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin: 8px 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #streakProgressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        .animate-reveal {
            animation: reveal 0.2s ease-out forwards;
        }

        @keyframes reveal {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body onclick="startAudio()">

    <!-- UI Buttons -->
    <div class="fixed top-2 left-2 z-50 flex flex-col gap-1.5">
        <div class="flex gap-1.5">
            <button onclick="toggleMusic()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition">
                <span id="musicIcon" class="text-lg">üîá</span>
            </button>
            <button onclick="toggleUpdateLog()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition">
                <span class="text-lg">üìú</span>
            </button>
        </div>
        <div class="glass-box !py-1 !px-2 opacity-50 w-fit">
            <span class="text-[8px] font-black uppercase tracking-tighter">Version 3.3</span>
        </div>
    </div>

    <div class="fixed top-2 right-2 flex flex-col gap-1.5 z-50">
        <button id="authBtn" onclick="toggleAuth()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition" title="Profile">
            <span class="text-xl">üë§</span>
        </button>
        <button onclick="toggleLeaderboard()" class="glass-box !p-0 !w-10 !h-10 flex items-center justify-center hover:bg-gray-800 transition" title="Leaderboard">
            <span class="text-xl">üèÜ</span>
        </button>
        <div class="glass-box !p-0 flex flex-col items-center justify-center !w-10 !h-10" title="Your Streak">
            <span class="text-lg">üî•</span>
            <span id="streakCount" class="text-[8px] font-black -mt-1">0</span>
        </div>
    </div>

    <!-- Modals -->
    <div id="updateModal" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[280px]">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">Update Log (v3.3)</h2>
            <ul class="text-[9px] text-gray-300 space-y-2 uppercase list-disc list-inside">
                <li>Restored Streak Progress Bar</li>
                <li>Leaderboard system fixed (Supabase)</li>
                <li>Added All Towers (50+ towers)</li>
                <li>Pixel mode starts at 2x2 and doubles per fail</li>
            </ul>
            <button onclick="toggleUpdateLog()" class="mt-4 w-full bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Dismiss</button>
        </div>
    </div>

    <div id="leaderboardModal" class="fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[280px]">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-3">Leaderboard</h2>
            <div id="leaderboardList" class="space-y-2 max-h-[200px] overflow-y-auto mb-4">
                <p class="text-[10px] text-gray-400 text-center py-4">Loading scores...</p>
            </div>
            <button onclick="toggleLeaderboard()" class="w-full bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Close</button>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 hidden">
        <div class="glass-box w-full max-w-[280px] text-center">
            <h2 class="text-yellow-500 font-black uppercase text-sm mb-4">Sign In</h2>
            <div id="authForm" class="flex flex-col gap-2">
                <input type="email" id="emailInput" placeholder="Email" class="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-xs">
                <input type="password" id="passwordInput" placeholder="Password" class="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-xs">
                <button onclick="handleLogin()" class="bg-yellow-500 text-black font-black py-2 rounded-lg text-xs uppercase">Login / Register</button>
                
                <div class="flex items-center my-2">
                    <hr class="flex-grow border-white/10">
                    <span class="mx-2 text-[8px] text-gray-500 uppercase">Or</span>
                    <hr class="flex-grow border-white/10">
                </div>

                <button onclick="signInWithDiscord()" class="flex items-center justify-center gap-2 bg-[#5865F2] hover:bg-[#4752C4] text-white font-black py-2 rounded-lg text-xs uppercase transition">
                    <img src="https://img.icons8.com/ios-filled/50/ffffff/discord-logo.png" class="w-4 h-4">
                    Sign In with Discord
                </button>
            </div>
            <div id="userInfo" class="hidden">
                <p id="userName" class="text-xs font-bold mb-4"></p>
                <button onclick="handleLogout()" class="text-red-500 text-[10px] uppercase font-bold">Logout</button>
            </div>
            <button onclick="toggleAuth()" class="mt-4 text-[8px] text-gray-500 uppercase">Close</button>
        </div>
    </div>

    <!-- Main Game Area -->
    <div class="game-wrapper">
        <div class="flex flex-col items-center mb-1">
            <img src="assets/logo.png" alt="TDX Guessr Logo" onerror="this.src='https://i.postimg.cc/Sj6mc3GZ/unnamed.png'" class="w-full max-h-24 object-contain">
        </div>

        <div class="glass-box">
            <div class="grid grid-cols-4 gap-1.5">
                <button onclick="changeMode('classic')" id="mode-classic" class="mode-btn active flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/sword.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Classic</span>
                </button>
                <button onclick="changeMode('pixel')" id="mode-pixel" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/picture.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Pixel</span>
                </button>
                <button onclick="changeMode('emoji')" id="mode-emoji" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/happy.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Emoji</span>
                </button>
                <button onclick="changeMode('description')" id="mode-description" class="mode-btn flex flex-col items-center">
                    <img src="https://img.icons8.com/color/48/document.png" class="w-5 h-5 mb-1">
                    <span class="text-[7px] uppercase font-bold">Desc</span>
                </button>
            </div>
        </div>

        <div class="glass-box flex flex-col items-center">
            <div id="displayArea" class="w-full min-h-[140px] flex flex-col items-center justify-center">
                <div id="pixelDisplay" class="hidden text-center relative w-full">
                    <div class="pixel-container mx-auto shadow-inner relative group">
                        <canvas id="pixelCanvas"></canvas>
                        <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                            <span class="text-[10px]">üîÑ</span>
                        </button>
                    </div>
                </div>

                <div id="emojiDisplay" class="hidden text-center w-full">
                    <div class="flex items-center justify-center gap-2">
                        <div id="emojiSlots" class="flex gap-1.5 text-2xl bg-black/50 p-3 rounded-lg min-h-[50px] min-w-[120px] justify-center items-center"></div>
                        <button onclick="refreshTower()" class="action-icon-btn">
                            <span class="text-[12px]">üîÑ</span>
                        </button>
                    </div>
                </div>

                <div id="descriptionDisplay" class="hidden text-center p-3 bg-black/40 rounded-lg w-full relative group">
                    <p id="descText" class="text-[10px] italic text-yellow-50"></p>
                    <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px]">üîÑ</span>
                    </button>
                </div>

                <div id="classicDisplay" class="text-center p-2 relative group w-full">
                    <h3 class="text-lg mb-1 text-yellow-400 uppercase font-black">Unknown Tower</h3>
                    <p class="text-gray-400 text-[9px] uppercase">Guess the tower's stats</p>
                    <button onclick="refreshTower()" class="absolute top-1 right-1 action-icon-btn opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[10px]">üîÑ</span>
                    </button>
                </div>
            </div>

            <div id="interactionSection" class="w-full relative mt-2">
                <input type="text" id="guessInput" placeholder="Guess a tower..." autocomplete="off"
                       class="w-full bg-black/50 border border-white/10 rounded-lg p-2 text-sm focus:border-yellow-500 outline-none text-white">
                <div id="suggestions" class="absolute bottom-full left-0 w-full glass-box mb-2 max-h-40 overflow-y-auto hidden z-50 !p-1"></div>
                
                <!-- Restored Progress Bar -->
                <div class="progress-container">
                    <div id="streakProgressBar"></div>
                </div>
                
                <button onclick="giveUp()" id="giveUpBtn" class="w-full text-[8px] font-bold text-gray-500 uppercase hover:text-red-400 py-1">Reveal Answer</button>
            </div>

            <div id="winControls" class="hidden w-full mt-2 flex flex-col gap-1.5">
                <div id="winStatusText" class="text-center text-[10px] font-black uppercase mb-1"></div>
                <button onclick="resetGame()" class="w-full bg-green-600 hover:bg-green-500 p-2 rounded-lg font-black text-xs">NEXT ROUND</button>
            </div>

            <div id="guessHistory" class="w-full mt-3 space-y-1.5"></div>
        </div>
    </div>

    <script>
        const towers = [
            { name: "Ranger", range: "Medium", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/61/RangerNew.png", desc: "Starter Tower, Shoots Basic Rifle", emojis: ["üî´", "üå≤", "üéØ"] },
            { name: "Shotgunner", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/5/56/ShotgunnerBase.png", desc: "Uses a shotgun", emojis: ["üêö", "üî•", "üí®"] },
            { name: "Operator", range: "Medium", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/66/Operator_0.png", desc: "Has a fast gun and can spawn cars", emojis: ["üöó", "‚ö°", "üìû"] },
            { name: "Mine Layer", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/a2/Mine_Layer_0.png", desc: "Puts mines on track every so often", emojis: ["üí£", "üõ£Ô∏è", "üí•"] },
            { name: "Sniper", range: "Long", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/f/f7/Sniper_0.png", desc: "Long Ranger Sniper.", emojis: ["üî≠", "üèπ", "üéØ"] },
            { name: "Cryo Blaster", range: "Slightly-Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/7/79/Cryoblaster_0.png", desc: "An ice tower that freezes stuff", emojis: ["‚ùÑÔ∏è", "üßä", "üßä"] },
            { name: "Missile Trooper", range: "Medium", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/b/bc/VSMissileTrooper.png", desc: "Shoots rockets", emojis: ["üöÄ", "üéñÔ∏è", "üî•"] },
            { name: "Patrol Boat", range: "Slightly Short", rarity: "Beginner", place: "Water", img: "https://static.wikia.nocookie.net/tdx/images/b/bc/VSMissileTrooper.png", desc: "A water unit that shoots (a boat)", emojis: ["üö§", "üåä", "‚öì"] },
            { name: "Farm", range: "N/A", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/b/bb/Farm_0_IG.png", desc: "Generates money every wave", emojis: ["üí∞", "üöú", "üí∏"] },
            { name: "Barracks", range: "N/A", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/c/c1/Barracks_0.png", desc: "Spawns riflemen and flametrooper men", emojis: ["üèòÔ∏è", "üíÇ", "üíÇ‚Äç‚ôÇÔ∏è"] },
            { name: "Grenadier", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/6c/Grenadier_0.png", desc: "Throws grenades", emojis: ["üß®", "üí•", "üí®"] },
            { name: "EDJ", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/e/ed/EDJ_0.png", desc: "Gives discount and fireate buffs to nearby towers", emojis: ["üéß", "üéµ", "üï∫"] },
            { name: "John", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/1/16/John_0.png", desc: "The creator of tdx. But a tower. With a glock19", emojis: ["üí™", "üï∂Ô∏è", "ü§ú"] },
            { name: "Laser Gunner", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/68/Laser_0.png", desc: "Shoots piercing lasers", emojis: ["üî´", "‚ö°", "üîã"] },
            { name: "Toxicnator", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/5/51/Toxicnator_0.png", desc: "Poisons enemies", emojis: ["üß™", "ü§¢", "‚ò£Ô∏è"] },
            { name: "Sentry", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/a1/SentryBase.png", desc: "Has an arc range, a worse version of machine gunner.", emojis: ["üèóÔ∏è", "ü§ñ", "üî´"] },
            { name: "Artillery", range: "Long", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/3/36/Artillery_0.png", desc: "Controllable mortar", emojis: ["üåã", "‚òÑÔ∏è", "üí•"] },
            { name: "Jet Trooper", range: "Short", rarity: "Intermediate", place: "Air", img: "https://static.wikia.nocookie.net/tdx/images/4/45/JetTrooper0.png", desc: "Flying tower, shoots missiles in bursts", emojis: ["‚úàÔ∏è", "üöÄ", "üå©Ô∏è"] },
            { name: "AA-Turret", range: "Long", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/d/dc/AATurret0.png", desc: "Can only shoot flying enemies; with missles", emojis: ["üö´", "üõ∏", "üöÄ"] },
            { name: "Armored Factory", range: "N/A", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/a5/Armored_Factory_0.png", desc: "Spawns armored tanks", emojis: ["üè≠", "üöú", "üõ°Ô∏è"] },
            { name: "Juggernaut", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/f/f2/Jug_0.png", desc: "A minigun troop", emojis: ["ü¶æ", "üî•", "üõ°Ô∏è"] },
            { name: "Ghost", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/0/04/GhostBase.png", desc: "A girl with an uzi who can stealth herself", emojis: ["üëª", "üî´", "üï∂Ô∏è"] },
            { name: "Mobster", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/3/3d/MobsterBase.png", desc: "Spawns goons and makes money", emojis: ["üé©", "üî´", "üíµ"] },
            { name: "Rail Gunner", range: "Long", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/4/42/Railgunner_0.png", desc: "A slow firing laser shooter", emojis: ["‚ö°", "üîã", "üéØ"] },
            { name: "Machine Gunner", range: "Medium", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/f/fe/MachineGunner0.png", desc: "A gunner with an arc range", emojis: ["üî´", "üí®", "üå©Ô∏è"] },
            { name: "Medic", range: "Medium", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/4/44/MedicBase.png", desc: "A troop that can heal nearby towers", emojis: ["üöë", "‚ûï", "üíâ"] },
            { name: "Slammer", range: "Short", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/6f/SlammerBase.png", desc: "A meele tower with a hammer (female)", emojis: ["üî®", "üëß", "üí•"] },
            { name: "XWM Turret", range: "Long", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/ad/XWMBase.png", desc: "A turret that can rebuild after death (female controler)", emojis: ["üõ†Ô∏è", "ü§ñ", "üóº"] },
            { name: "Golden Ranger", range: "Medium", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/d/db/GoldenRangerBase.png", desc: "A better golden varient of ranger", emojis: ["‚ú®", "üëë", "üî´"] },
            { name: "Golden Mine Layer", range: "Short", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/2/29/GoldenMineLayerBase.png", desc: "Better golden variant of normal mine layer", emojis: ["‚ú®", "üí£", "üî±"] },
            { name: "Combat Drone", range: "N/A", rarity: "Late Game", place: "Air", img: "https://static.wikia.nocookie.net/tdx/images/9/9e/CombatDrone0.png", desc: "A controllable shooter drone", emojis: ["üõ∏", "üéÆ", "üî´"] },
            { name: "Warship", range: "Very Long", rarity: "Late Game", place: "Water", img: "https://static.wikia.nocookie.net/tdx/images/e/ee/Warship_0.png", desc: "A navy ship.", emojis: ["üö¢", "üåä", "‚öì"] },
            { name: "Helicopter", range: "Very Long", rarity: "Late Game", place: "Air", img: "https://static.wikia.nocookie.net/tdx/images/7/7d/HelicopterBase.png", desc: "A flying high dps heli", emojis: ["üöÅ", "‚öîÔ∏è", "üî•"] },
            { name: "Golden Juggernaut", range: "Medium", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/f/f0/GoldenJuggernautBase.png", desc: "A high dps golden varient of juggernaught (uses minigun)", emojis: ["‚ú®", "ü¶æ", "üëë"] },
            { name: "Golden Mobster", range: "Medium", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/d/dd/GoldenMobster0.png", desc: "Generates Money and spawns goons (golden variant; better)", emojis: ["‚ú®", "üí∞", "üëë"] },
            { name: "Shield Tower", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/a4/ShieldTower0.png", desc: "Protects towers", emojis: ["üõ°Ô∏è", "üèóÔ∏è", "üí°"] },
            { name: "Oil Derrick", range: "N/A", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/9/91/OilDerrick0.png", desc: "Generates money by pumping oil", emojis: ["üõ¢Ô∏è", "üí∞", "üè≠"] },
            { name: "Behemoth Factory", range: "N/A", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/2/20/BehemothFactory0.png", desc: "Spawns tanks", emojis: ["üè≠", "üöú", "üíÄ"] },
            { name: "Commander", range: "Medium", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/a/a8/CommanderBase.png", desc: "Buffs damage and fireate of nearby towers", emojis: ["üó£Ô∏è", "üéñÔ∏è", "üì£"] },
            { name: "War Machine Factory", range: "N/A", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/e/ea/WarMachineFactory0.png", desc: "Spawns high dps walker mechs (armed)", emojis: ["üè≠", "ü¶æ", "üí•"] },
            { name: "Refractor", range: "Long", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/c/ca/Refractor0.png", desc: "A high dps tower that shoots lazer ray", emojis: ["üíé", "‚ö°", "üåà"] },
            { name: "Cryo Ranger", range: "Medium", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/8/81/Cryo_Ranger_0.png", desc: "Like ranger, but shoots ice", emojis: ["‚ùÑÔ∏è", "üî´", "üèπ"] },
            { name: "Z.E.D.", range: "N/A", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/c/cd/ZedBase.png", desc: "Spawns A high-tech armed vehicle", emojis: ["üöì", "ü§ñ", "üö®"] },
            { name: "Scarecrow", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/1/19/ScarecrowBase.png", desc: "Baits Boss attacks", emojis: ["üåæ", "üéÉ", "üèπ"] },
            { name: "Flame Trooper", range: "Medium", rarity: "Intermediate", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/2/2d/FlameTrooperBase.png", desc: "Pyromancer, uses a flamethrower", emojis: ["üî•", "üöí", "üåã"] },
            { name: "Relic", range: "N/A", rarity: "Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/b/ba/RelicBase.png", desc: "Spawns Undead Creatures", emojis: ["üíÄ", "‚ö∞Ô∏è", "üîÆ"] },
            { name: "Cryo Helicopter", range: "Very Long", rarity: "Intermediate", place: "Air", img: "https://static.wikia.nocookie.net/tdx/images/0/00/CryoHelicopter0.png", desc: "Like helicopter, but shoots ice ray", emojis: ["üöÅ", "‚ùÑÔ∏è", "üå¨Ô∏è"] },
            { name: "Ice Breaker", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/3/39/IceBreaker0.png", desc: "Freezes enemies with meele", emojis: ["‚ùÑÔ∏è", "üî®", "üßä"] },
            { name: "Troll Tower", range: "Short", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/b/b6/TrollTower0.png", desc: "Meme tower, Baits boss attacks", emojis: ["ü§°", "üé≠", "üö©"] },
            { name: "Goo Gunner", range: "Medium", rarity: "Beginner", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/6f/GooGunner0.png", desc: "Uses sticky goo to slow down enemies", emojis: ["üß™", "üçØ", "üï∏Ô∏è"] },
            { name: "Shock Trooper", range: "Long", rarity: "Slightly Late Game", place: "Ground", img: "https://static.wikia.nocookie.net/tdx/images/6/6d/ShockTrooper0.png", desc: "Shocks crowds of enemies", emojis: ["‚ö°", "üîã", "üå©Ô∏è"] }
        ];

        // Supabase Init
        const supabaseUrl = 'https://YOUR_SUPABASE_URL.supabase.co';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let targetTower, currentMode = 'classic', guesses = [], streak = 0, pixelRes = 2;
        let currentUser = null;
        let isMusicPlaying = false;
        let audioContext = null;

        function startAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function toggleMusic() {
            isMusicPlaying = !isMusicPlaying;
            const musicIcon = document.getElementById('musicIcon');
            musicIcon.innerText = isMusicPlaying ? 'üîä' : 'üîá';
        }

        async function updateLeaderboard() {
            try {
                const { data, error } = await supabaseClient
                    .from('leaderboard')
                    .select('*')
                    .order('streak', { ascending: false })
                    .limit(10);

                if (data) {
                    const list = document.getElementById('leaderboardList');
                    list.innerHTML = data.map((s, i) => `
                        <div class="flex justify-between items-center p-2 bg-white/5 rounded">
                            <span class="text-[9px] uppercase font-bold text-gray-400">#${i+1} ${s.username}</span>
                            <span class="text-yellow-500 font-black">${s.streak} üî•</span>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('leaderboardList').innerHTML = '<p class="text-[8px] text-center text-gray-500">NO SCORES FOUND</p>';
                }
            } catch (err) {
                console.error("Leaderboard error:", err);
            }
        }

        async function saveStreak() {
            if (!currentUser) return;
            try {
                await supabaseClient
                    .from('leaderboard')
                    .upsert({ 
                        user_id: currentUser.id, 
                        username: currentUser.email?.split('@')[0] || "Player", 
                        streak: streak 
                    });
            } catch (err) {
                console.error("Save error:", err);
            }
        }

        function toggleAuth() { document.getElementById('authModal').classList.toggle('hidden'); }
        
        async function signInWithDiscord() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                  provider: 'discord',
                });
                if (error) throw error;
            } catch (err) {
                console.error("Discord auth error:", err);
            }
        }

        async function handleLogin() {
            currentUser = { id: 'mock-user', email: 'player@example.com' };
            document.getElementById('authForm').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userName').innerText = "Logged in as: Player";
        }
        
        function handleLogout() {
            currentUser = null;
            document.getElementById('authForm').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }

        function resetGame() {
            targetTower = towers[Math.floor(Math.random() * towers.length)];
            guesses = []; pixelRes = 2;
            document.getElementById('guessHistory').innerHTML = '';
            document.getElementById('winControls').classList.add('hidden');
            document.getElementById('interactionSection').classList.remove('hidden');
            document.getElementById('guessInput').value = '';
            
            // Set Progress Bar to 0% for new round
            document.getElementById('streakProgressBar').style.width = '0%';

            ['pixelDisplay', 'emojiDisplay', 'descriptionDisplay', 'classicDisplay'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(currentMode + 'Display').classList.remove('hidden');
            updateDisplay();
        }

        function updateDisplay() {
            if(currentMode === 'emoji') {
                document.getElementById('emojiSlots').innerHTML = targetTower.emojis.map((e, i) => i === 0 ? `<span>${e}</span>` : `<span class="opacity-20">?</span>`).join('');
            } else if(currentMode === 'description') {
                const words = targetTower.desc.split(' ');
                document.getElementById('descText').innerText = words.map((w, i) => i < 2 ? w : '_'.repeat(w.length)).join(' ');
            } else if(currentMode === 'pixel') {
                drawPixelated();
            }
        }

        function drawPixelated() {
            const canvas = document.getElementById('pixelCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = targetTower.img;
            img.onload = () => {
                canvas.width = 120; canvas.height = 120;
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(img, 0, 0, pixelRes, pixelRes);
                ctx.drawImage(canvas, 0, 0, pixelRes, pixelRes, 0, 0, 120, 120);
            };
        }

        function handleGuess(name) {
            const guess = towers.find(t => t.name.toLowerCase() === name.trim().toLowerCase());
            if(!guess) return;
            document.getElementById('guessInput').value = '';
            document.getElementById('suggestions').classList.add('hidden');
            
            guesses.push(guess);
            if(guess.name === targetTower.name) {
                streak++;
                document.getElementById('streakCount').innerText = streak;
                document.getElementById('winStatusText').innerText = "CORRECT! IT WAS " + targetTower.name;
                document.getElementById('winControls').classList.remove('hidden');
                document.getElementById('interactionSection').classList.add('hidden');
                
                // Perfect progress bar on win
                document.getElementById('streakProgressBar').style.width = '100%';

                if(currentMode === 'pixel') { pixelRes = 120; drawPixelated(); }
                saveStreak();
            } else {
                // Update progress bar based on guess attempts (maxed at 6 guesses for visual feedback)
                const progress = Math.min(guesses.length * 15, 90);
                document.getElementById('streakProgressBar').style.width = progress + '%';

                pixelRes = Math.min(pixelRes * 2, 64);
                if(currentMode === 'pixel') drawPixelated();
                if(currentMode === 'emoji') {
                    const shown = Math.min(guesses.length + 1, targetTower.emojis.length);
                    document.getElementById('emojiSlots').innerHTML = targetTower.emojis.map((e, i) => i < shown ? `<span>${e}</span>` : `<span class="opacity-20">?</span>`).join('');
                }
            }
            addGuessRow(guess);
        }

        function addGuessRow(guess) {
            const container = document.getElementById('guessHistory');
            const row = document.createElement('div');
            row.className = "flex flex-col gap-1 mb-2 animate-reveal";
            const compare = (key) => guess[key] === targetTower[key] ? 'correct' : 'incorrect';
            
            row.innerHTML = `
                <div class="flex items-center gap-2 glass-box !p-1 border ${guess.name === targetTower.name ? 'correct' : 'incorrect'}">
                    <img src="${guess.img}" class="w-6 h-6 rounded">
                    <span class="text-[9px] font-black uppercase">${guess.name}</span>
                </div>
                <div class="grid grid-cols-4 gap-1 mt-1">
                    <div class="stat-box ${compare('rarity')}"><span>Rarity</span><br>${guess.rarity}</div>
                    <div class="stat-box ${compare('range')}"><span>Range</span><br>${guess.range}</div>
                    <div class="stat-box ${compare('place')}"><span>Place</span><br>${guess.place}</div>
                    <div class="stat-box ${guess.name === targetTower.name ? 'correct' : 'incorrect'}"><span>Name</span><br>${guess.name === targetTower.name ? '‚úî' : '‚úò'}</div>
                </div>
            `;
            container.prepend(row);
        }

        function toggleUpdateLog() { document.getElementById('updateModal').classList.toggle('hidden'); }
        function toggleLeaderboard() { 
            const m = document.getElementById('leaderboardModal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) updateLeaderboard();
        }
        function changeMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            resetGame();
        }
        function giveUp() {
            streak = 0;
            document.getElementById('streakCount').innerText = 0;
            document.getElementById('winStatusText').innerText = "IT WAS: " + targetTower.name;
            document.getElementById('winControls').classList.remove('hidden');
            document.getElementById('interactionSection').classList.add('hidden');
            document.getElementById('streakProgressBar').style.width = '0%';
            saveStreak();
        }
        function refreshTower() { resetGame(); }

        document.getElementById('guessInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const suggs = document.getElementById('suggestions');
            if(!val) { suggs.classList.add('hidden'); return; }
            const matches = towers.filter(t => t.name.toLowerCase().includes(val)).slice(0, 5);
            if(matches.length > 0) {
                suggs.innerHTML = matches.map(m => `
                    <div class="p-2 flex items-center gap-2 cursor-pointer hover:bg-white/5" onclick="handleGuess('${m.name}')">
                        <img src="${m.img}" class="w-5 h-5 rounded">
                        <span class="text-[8px] font-bold uppercase">${m.name}</span>
                    </div>`).join('');
                suggs.classList.remove('hidden');
            } else suggs.classList.add('hidden');
        });

        document.getElementById('guessInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleGuess(e.target.value); });

        resetGame();
    </script>
</body>
</html>
